# Electron tutorial


## Minimal permissions

At the very least you need:

    "--share=ipc",
    "--socket=x11",
Electron does not currently support wayland.

If your application plays sound:

    "--socket=pulseaudio",

If your application accesses the network:

    "--share=network"

## Using the electron base app

Electron requires some legacy dependencies like gtk2 that the freedesktop runtime doesn't include. It would be possible to build these as modules manually, but because these dependencies are the same for every electron app, a base app has been created that includes them and allows installing nodejs and electron without any further issue.

In order to be used, it must be included in the manifest:

    "base": "io.atom.electron.BaseApp",
    "base-version": "stable",

Using the base app also has other advantages:
 - Deduplication, by ensuring they are built in the same way, it allows ostree to deduplicate the dependencies. This way users with several electron apps installed won't need to waste hard drive on them.
 - Decreased build times, as it only needs to be built once.

## Building nodejs

The electron base app does not include nodejs (only its dependencies), it is necessary to build it as a module. This tutorial builds 8.11.1 because it works with most projects at the time of writing, but make sure to use whichever version is best for your project.

    {
        "name": "nodejs",
        "cleanup": [
            "/include",
            "/share",
            "/app/lib/node_modules/npm/changelogs",
            "/app/lib/node_modules/npm/doc",
            "/app/lib/node_modules/npm/html",
            "/app/lib/node_modules/npm/man",
            "/app/lib/node_modules/npm/scripts"
        ],
        "sources": [
            {
                "type": "archive",
                "url": "https://nodejs.org/dist/v8.11.1/node-v8.11.1.tar.xz",
                "sha256": "40a6eb51ea37fafcf0cfb58786b15b99152bec672cccf861c14d1cca0ad4758a"
            }
        ]
    }

Note that the cleanup isn't strictly necessary, but removing documentation helps reduce final disk size of the bundle.

## Building your npm dependencies

Because npm won't be able to access the network from inside the sandbox, dependencies must be downloaded as sources and installed using `--offline`.

The nature of electron development makes doing this manually impractical, as even the simplest applications depend on multiple dozen different packages. A [python script](https://github.com/flatpak/flatpak-builder-tools/tree/master/npm) has been developed to scrape the packages from npm and include them in your sources.

Using it requires a `package-lock.json` file. If you aren't familiar with nodejs, this file contains information about the versions of different packages that your application depends on and can be generated by running `npm install` on your application's root directory.

Once you have your `package-lock.json` file, the sources can be generated:

    python3 flatpak-npm-generator.py package-lock.json

This will output a file called `generated-sources.json`, its contents can be directly embedded in your manifest, but it is usually so large that keeping it separate and linking to it is more convenient.
